.PHONY: help setup build run test clean docker fix-go

# Default target
help:
	@echo "Token Vesting Backend API - Make Commands"
	@echo "=========================================="
	@echo ""
	@echo "Setup:"
	@echo "  make fix-go      - Fix Go environment variables"
	@echo "  make setup       - Install dependencies"
	@echo "  make db-start    - Start PostgreSQL (Docker)"
	@echo "  make db-stop     - Stop PostgreSQL"
	@echo ""
	@echo "Development:"
	@echo "  make run         - Run the API server"
	@echo "  make dev         - Run with auto-reload"
	@echo "  make build       - Build the API binary"
	@echo "  make test        - Run tests"
	@echo "  make fmt         - Format code"
	@echo "  make lint        - Run linter"
	@echo ""
	@echo "Database:"
	@echo "  make db-start    - Start PostgreSQL with Docker"
	@echo "  make db-stop     - Stop PostgreSQL"
	@echo "  make db-reset    - Reset database (WARNING: deletes data)"
	@echo "  make db-shell    - Open PostgreSQL shell"
	@echo ""
	@echo "Cleanup:"
	@echo "  make clean       - Clean build artifacts"
	@echo ""

# Fix Go environment
fix-go:
	@echo "ðŸ”§ Fixing Go environment..."
	./fix-go-env.sh

# Setup project
setup:
	@echo "ðŸ“¦ Installing dependencies..."
	go mod download
	go mod tidy
	@echo "âœ… Setup complete!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. make db-start        # Start PostgreSQL"
	@echo "  2. cp .env.docker .env  # Configure environment"
	@echo "  3. make run             # Start API server"

# Build binary
build:
	@echo "ðŸ”¨ Building API server..."
	go build -o bin/api cmd/api/main.go
	@echo "âœ… Binary built: bin/api"

# Run server
run:
	@echo "ðŸš€ Starting API server..."
	go run cmd/api/main.go

# Run tests
test:
	@echo "ðŸ§ª Running tests..."
	go test -v ./...

# Format code
fmt:
	@echo "âœ¨ Formatting code..."
	go fmt ./...

# Lint code
lint:
	@echo "ðŸ” Linting code..."
	golangci-lint run

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning..."
	rm -rf bin/
	rm -f *.log
	@echo "âœ… Clean complete!"

# Build Docker image
docker:
	@echo "ðŸ³ Building Docker image..."
	docker build -t vesting-api:latest .
	@echo "âœ… Docker image built!"

# Start PostgreSQL with Docker
db-start:
	@echo "ðŸ˜ Starting PostgreSQL with Docker..."
	docker-compose up -d postgres
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@sleep 5
	@echo "âœ… PostgreSQL is running!"
	@echo ""
	@echo "Connection details:"
	@echo "  Host: localhost"
	@echo "  Port: 5432"
	@echo "  User: vesting"
	@echo "  Password: vesting123"
	@echo "  Database: vesting"

# Stop PostgreSQL
db-stop:
	@echo "ðŸ›‘ Stopping PostgreSQL..."
	docker-compose down
	@echo "âœ… PostgreSQL stopped"

# Reset database (WARNING: deletes all data)
db-reset:
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down -v; \
		docker-compose up -d postgres; \
		sleep 5; \
		echo "âœ… Database reset complete"; \
	fi

# Open PostgreSQL shell
db-shell:
	@echo "ðŸ˜ Opening PostgreSQL shell..."
	docker-compose exec postgres psql -U vesting

# View database logs
db-logs:
	@echo "ðŸ“‹ PostgreSQL logs:"
	docker-compose logs -f postgres

# Development mode with auto-reload (requires air)
dev:
	@echo "ðŸ”¥ Starting development server with auto-reload..."
	@command -v air >/dev/null 2>&1 || { echo "Installing air..."; go install github.com/cosmtrek/air@latest; }
	air
